<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sofi Cashflow Tracker (Cloud Sync)</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- Firebase init with your real config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCj4VxtalspWcMmrilRlZ3zld3vg9_y86k",
      authDomain: "jimmy-apps-a3bc2.firebaseapp.com",
      projectId: "jimmy-apps-a3bc2",
      storageBucket: "jimmy-apps-a3bc2.firebasestorage.app",
      messagingSenderId: "598334691661",
      appId: "1:598334691661:web:6d773624e8f19c8dc97f04"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Helpers ---
    const FREQUENCIES = [
      { key: "WEEKLY", label: "Weekly" },
      { key: "BIWEEKLY", label: "Biweekly" },
      { key: "MONTHLY", label: "Monthly" },
    ];
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    const toISODate = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0, 10);
    const parseISO = (s) => { const [y, m, d] = s.split("-").map(Number); return new Date(y, m - 1, d); };
    function addDays(date, n) { const d = new Date(date); d.setDate(d.getDate() + n); return d; }
    function addMonths(date, n) { const d = new Date(date); d.setMonth(d.getMonth() + n); return d; }
    function nextBiweekly(from, anchor) {
      const oneDay = 24 * 60 * 60 * 1000;
      const start = new Date(anchor);
      const f = new Date(from);
      const diffDays = Math.floor((f - start) / oneDay);
      const mod = ((diffDays % 14) + 14) % 14;
      return addDays(f, mod === 0 ? 0 : 14 - mod);
    }
    function enumerateOccurrences(rule, horizonStart, horizonEnd) {
      const out = [];
      const { frequency, anchorDate } = rule;
      if (!frequency || !anchorDate) return out;
      let cur;
      const start = parseISO(horizonStart);
      const end = parseISO(horizonEnd);
      const anchor = parseISO(anchorDate);
      if (frequency === "WEEKLY") {
        cur = new Date(start);
        while (cur.getDay() !== anchor.getDay()) cur = addDays(cur, 1);
        while (cur <= end) { out.push(toISODate(cur)); cur = addDays(cur, 7); }
      } else if (frequency === "BIWEEKLY") {
        cur = nextBiweekly(start, anchor);
        while (cur <= end) { out.push(toISODate(cur)); cur = addDays(cur, 14); }
      } else if (frequency === "MONTHLY") {
        let temp = new Date(start);
        temp.setDate(anchor.getDate());
        if (temp < start) temp = addMonths(temp, 1);
        while (temp <= end) {
          const y = temp.getFullYear(), m = temp.getMonth();
          const daysInMonth = new Date(y, m + 1, 0).getDate();
          const day = Math.min(anchor.getDate(), daysInMonth);
          const d = new Date(y, m, day);
          if (d >= start && d <= end) out.push(toISODate(d));
          temp = addMonths(temp, 1);
        }
      }
      return out;
    }

    function Card({ children, extra }) {
      return <div className={`rounded-2xl bg-white p-4 shadow-sm border border-slate-200 ${extra || ""}`}>{children}</div>;
    }

    // --- Main App ---
    function App() {
      const [user, setUser] = useState(null);
      const [accountName, setAccountName] = useState("SoFi Checking");
      const [startingBalance, setStartingBalance] = useState(0);
      const [asOfDate, setAsOfDate] = useState(toISODate(new Date()));
      const [lookaheadDays, setLookaheadDays] = useState(45);
      const [oneOffs, setOneOffs] = useState([]);
      const [recurrings, setRecurrings] = useState([]);

      // Auth listener
      useEffect(() => auth.onAuthStateChanged(setUser), []);

      // Load from Firestore
      useEffect(() => {
        if (!user) return;
        const ref = db.collection("cashflow").doc(user.uid);
        return ref.onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            setAccountName(data.accountName ?? "SoFi Checking");
            setStartingBalance(data.startingBalance ?? 0);
            setAsOfDate(data.asOfDate ?? toISODate(new Date()));
            setLookaheadDays(data.lookaheadDays ?? 45);
            setOneOffs(data.oneOffs ?? []);
            setRecurrings(data.recurrings ?? []);
          }
        });
      }, [user]);

      // Save to Firestore
      useEffect(() => {
        if (!user) return;
        db.collection("cashflow").doc(user.uid).set({
          accountName, startingBalance, asOfDate, lookaheadDays, oneOffs, recurrings
        });
      }, [user, accountName, startingBalance, asOfDate, lookaheadDays, oneOffs, recurrings]);

      const horizonStart = asOfDate;
      const horizonEnd = toISODate(addDays(parseISO(asOfDate), lookaheadDays));
      const upcoming = useMemo(() => {
        const offs = oneOffs
          .filter(t => t.date >= horizonStart && t.date <= horizonEnd)
          .map(t => ({ ...t, kind: "One-off" }));
        const rec = [];
        for (const r of recurrings) {
          const dates = enumerateOccurrences(r.rule, horizonStart, horizonEnd).filter(d => !r.endDate || d <= r.endDate);
          for (const d of dates) rec.push({ id: `${r.id}-${d}`, date: d, amount: r.amount, note: r.label, kind: r.rule.frequency });
        }
        const all = [...offs, ...rec].sort((a, b) => a.date.localeCompare(b.date));
        let balance = Number(startingBalance);
        const withRun = all.map(t => ({ ...t, runBalance: balance += Number(t.amount) }));
        return { items: withRun, projectedEnd: withRun.length ? withRun[withRun.length - 1].runBalance : Number(startingBalance) };
      }, [oneOffs, recurrings, startingBalance, horizonStart, horizonEnd]);

      if (!user) {
        return (
          <div className="p-8 text-center">
            <h1 className="text-2xl font-bold mb-4">Sofi Cashflow Tracker</h1>
            <button className="px-4 py-2 bg-blue-600 text-white rounded"
              onClick={() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())}>
              Sign in with Google
            </button>
          </div>
        );
      }

      return (
        <div className="p-4 sm:p-8 max-w-5xl mx-auto">
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-xl font-bold">Cashflow Tracker</h1>
            <button className="text-sm text-red-500" onClick={() => auth.signOut()}>Sign out</button>
          </div>
          {/* settings */}
          <section className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <Card><input value={accountName} onChange={e=>setAccountName(e.target.value)} className="border p-2 w-full"/></Card>
            <Card>
              <div className="flex gap-2">
                <input type="number" value={startingBalance} onChange={e=>setStartingBalance(Number(e.target.value))} className="border p-2 w-1/2"/>
                <input type="date" value={asOfDate} onChange={e=>setAsOfDate(e.target.value)} className="border p-2 w-1/2"/>
              </div>
            </Card>
            <Card><input type="number" value={lookaheadDays} onChange={e=>setLookaheadDays(Number(e.target.value))} className="border p-2 w-full"/></Card>
            <Card>Projected: ${upcoming.projectedEnd.toFixed(2)}</Card>
          </section>
          {/* You can paste your add-one-off and add-recurring forms from earlier here */}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
