<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sofi Cashflow Tracker (Cloud Sync)</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- Firebase init (your real config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCj4VxtalspWcMmrilRlZ3zld3vg9_y86k",
      authDomain: "jimmy-apps-a3bc2.firebaseapp.com",
      projectId: "jimmy-apps-a3bc2",
      storageBucket: "jimmy-apps-a3bc2.firebasestorage.app",
      messagingSenderId: "598334691661",
      appId: "1:598334691661:web:6d773624e8f19c8dc97f04"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- helpers ---
    const FREQUENCIES = [
      { key: "WEEKLY",   label: "Weekly" },
      { key: "BIWEEKLY", label: "Biweekly" },
      { key: "MONTHLY",  label: "Monthly" },
    ];
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toISODate = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
    const parseISO = (s) => { const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); };
    const addDays = (date,n)=>{ const d=new Date(date); d.setDate(d.getDate()+n); return d; };
    const addMonths=(date,n)=>{ const d=new Date(date); d.setMonth(d.getMonth()+n); return d; };
    function nextBiweekly(from, anchor){
      const oneDay=86400000, start=new Date(anchor), f=new Date(from);
      const diffDays=Math.floor((f-start)/oneDay);
      const mod=((diffDays%14)+14)%14;
      return addDays(f, mod===0 ? 0 : 14-mod);
    }
    function enumerateOccurrences(rule, horizonStart, horizonEnd){
      const out=[]; const {frequency, anchorDate}=rule; if(!frequency||!anchorDate) return out;
      let cur; const start=parseISO(horizonStart), end=parseISO(horizonEnd), anchor=parseISO(anchorDate);
      if(frequency==="WEEKLY"){
        cur=new Date(start); while(cur.getDay()!==anchor.getDay()) cur=addDays(cur,1);
        while(cur<=end){ out.push(toISODate(cur)); cur=addDays(cur,7); }
      }else if(frequency==="BIWEEKLY"){
        cur=nextBiweekly(start, anchor);
        while(cur<=end){ out.push(toISODate(cur)); cur=addDays(cur,14); }
      }else if(frequency==="MONTHLY"){
        let temp=new Date(start); temp.setDate(anchor.getDate()); if(temp<start) temp=addMonths(temp,1);
        while(temp<=end){
          const y=temp.getFullYear(), m=temp.getMonth();
          const daysInMonth=new Date(y,m+1,0).getDate();
          const day=Math.min(anchor.getDate(), daysInMonth);
          const d=new Date(y,m,day);
          if(d>=start && d<=end) out.push(toISODate(d));
          temp=addMonths(temp,1);
        }
      }
      return out;
    }
    const Card = ({children, extra}) => (
      <div className={`rounded-2xl bg-white p-4 shadow-sm border border-slate-200 ${extra||""}`}>{children}</div>
    );

    // --- App ---
    function App(){
      const [user,setUser]=useState(null);

      const [accountName,setAccountName]=useState("SoFi Checking");
      const [startingBalance,setStartingBalance]=useState(0);
      const [asOfDate,setAsOfDate]=useState(toISODate(new Date()));
      const [lookaheadDays,setLookaheadDays]=useState(45);
      const [oneOffs,setOneOffs]=useState([]);       // {id,date,amount,note}
      const [recurrings,setRecurrings]=useState([]); // {id,label,amount,rule{frequency,anchorDate},endDate?}

      // Auth
      useEffect(()=>auth.onAuthStateChanged(setUser),[]);

      // Firestore load
      useEffect(()=>{
        if(!user) return;
        const ref=db.collection("cashflow").doc(user.uid);
        return ref.onSnapshot(doc=>{
          if(doc.exists){
            const d=doc.data();
            setAccountName(d.accountName ?? "SoFi Checking");
            setStartingBalance(d.startingBalance ?? 0);
            setAsOfDate(d.asOfDate ?? toISODate(new Date()));
            setLookaheadDays(d.lookaheadDays ?? 45);
            setOneOffs(d.oneOffs ?? []);
            setRecurrings(d.recurrings ?? []);
          }
        });
      },[user]);

      // Firestore save (simple debounce)
      useEffect(()=>{
        if(!user) return;
        const ref=db.collection("cashflow").doc(user.uid);
        const payload={accountName, startingBalance, asOfDate, lookaheadDays, oneOffs, recurrings};
        const t=setTimeout(()=>ref.set(payload), 250);
        return ()=>clearTimeout(t);
      },[user,accountName,startingBalance,asOfDate,lookaheadDays,oneOffs,recurrings]);

      const horizonStart=asOfDate;
      const horizonEnd=toISODate(addDays(parseISO(asOfDate), lookaheadDays));

      const upcoming=useMemo(()=>{
        const offs=oneOffs
          .filter(t=>t.date>=horizonStart && t.date<=horizonEnd)
          .map(t=>({...t, kind:"One-off"}));
        const rec=[];
        for(const r of recurrings){
          const dates=enumerateOccurrences(r.rule, horizonStart, horizonEnd).filter(d=>!r.endDate || d<=r.endDate);
          for(const d of dates){
            rec.push({id:`${r.id}-${d}`, date:d, amount:r.amount, note:r.label, kind:r.rule.frequency});
          }
        }
        const all=[...offs, ...rec].sort((a,b)=>a.date.localeCompare(b.date));
        let balance=Number(startingBalance);
        const withRun=all.map(t=>{ balance += Number(t.amount); return {...t, runBalance: balance}; });
        const projectedEnd=withRun.length ? withRun[withRun.length-1].runBalance : Number(startingBalance);
        const firstNegative=withRun.find(t=>t.runBalance<0);
        return {items:withRun, projectedEnd, firstNegative};
      },[oneOffs,recurrings,startingBalance,horizonStart,horizonEnd]);

      // quick add (one-off)
      const [qDate,setQDate]=useState(toISODate(new Date()));
      const [qAmount,setQAmount]=useState(0);
      const [qNote,setQNote]=useState("");
      function addOneOff(){
        if(!qDate || !qAmount) return;
        setOneOffs(x=>[{id:uid(), date:qDate, amount:Number(qAmount), note:qNote}, ...x]);
        setQAmount(0); setQNote("");
      }
      function removeOneOff(id){ setOneOffs(x=>x.filter(t=>t.id!==id)); }

      // add recurring
      const [rLabel,setRLabel]=useState("Paycheck");
      const [rAmount,setRAmount]=useState(2500);
      const [rFrequency,setRFrequency]=useState("BIWEEKLY");
      const [rAnchor,setRAnchor]=useState(toISODate(new Date()));
      const [rEnd,setREnd]=useState("");
      function addRecurring(){
        setRecurrings(x=>[{id:uid(), label:rLabel, amount:Number(rAmount), rule:{frequency:rFrequency, anchorDate:rAnchor}, endDate:rEnd||undefined}, ...x]);
      }
      function removeRecurring(id){ setRecurrings(x=>x.filter(r=>r.id!==id)); }

      if(!user){
        return (
          <div className="p-8 text-center">
            <h1 className="text-2xl font-bold mb-4">Sofi Cashflow Tracker</h1>
            <button
              className="px-4 py-2 bg-blue-600 text-white rounded"
              onClick={async ()=>{
                try{
                  await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                }catch(e){
                  await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
                }
              }}
            >
              Sign in with Google
            </button>
          </div>
        );
      }

      const projectedBadge = upcoming.projectedEnd >= 0 ? "bg-emerald-100 text-emerald-800" : "bg-rose-100 text-rose-800";

      return (
        <div className="min-h-screen w-full bg-slate-50 p-4 sm:p-8">
          <div className="mx-auto max-w-6xl">
            <div className="flex items-center justify-between mb-4">
              <h1 className="text-2xl sm:text-3xl font-bold">Cashflow Tracker</h1>
              <button className="text-sm text-red-600" onClick={()=>auth.signOut()}>Sign out</button>
            </div>

            {/* Settings */}
            <section className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <Card>
                <div className="text-xs uppercase text-slate-500 mb-1">Account</div>
                <input className="w-full rounded-xl border p-2" value={accountName} onChange={e=>setAccountName(e.target.value)} />
              </Card>
              <Card>
                <div className="text-xs uppercase text-slate-500 mb-1">Starting balance (as of)</div>
                <div className="flex gap-2">
                  <input type="number" className="w-1/2 rounded-xl border p-2" value={startingBalance} onChange={e=>setStartingBalance(Number(e.target.value))} />
                  <input type="date" className="w-1/2 rounded-xl border p-2" value={asOfDate} onChange={e=>setAsOfDate(e.target.value)} />
                </div>
              </Card>
              <Card>
                <div className="text-xs uppercase text-slate-500 mb-1">Lookahead window</div>
                <div className="flex items-center gap-2">
                  <input type="number" className="w-24 rounded-xl border p-2" value={lookaheadDays} onChange={e=>setLookaheadDays(Number(e.target.value))} />
                  <span className="text-slate-600">days</span>
                </div>
              </Card>
              <Card extra="items-center">
                <div className="text-xs uppercase text-slate-500 mb-1">Projected @ end</div>
                <div className={`inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold ${projectedBadge}`}>
                  ${upcoming.projectedEnd.toFixed(2)}
                </div>
              </Card>
            </section>

            {/* Adders */}
            <section className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
              <div className="lg:col-span-2">
                <Card>
                  <h2 className="text-lg font-semibold mb-3">Add one-off</h2>
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <input type="date" className="rounded-xl border p-2" value={qDate} onChange={e=>setQDate(e.target.value)} />
                    <input type="number" className="rounded-xl border p-2" value={qAmount} onChange={e=>setQAmount(Number(e.target.value))} placeholder="Amount (+/-)" />
                    <input type="text" className="rounded-xl border p-2" value={qNote} onChange={e=>setQNote(e.target.value)} placeholder="Note (Venmo, rent, etc.)" />
                    <button onClick={addOneOff} className="rounded-xl px-4 py-2 bg-blue-600 text-white shadow">Add</button>
                  </div>
                  <p className="text-xs text-slate-500 mt-2">Income is positive (e.g., +2500), expenses negative (e.g., -125.73).</p>
                </Card>
              </div>

              <div>
                <Card>
                  <h2 className="text-lg font-semibold mb-3">Add recurring</h2>
                  <div className="grid grid-cols-2 gap-3">
                    <input className="rounded-xl border p-2 col-span-2" value={rLabel} onChange={e=>setRLabel(e.target.value)} placeholder="Label (Paycheck, Rent)" />
                    <input type="number" className="rounded-xl border p-2" value={rAmount} onChange={e=>setRAmount(Number(e.target.value))} placeholder="Amount" />
                    <select className="rounded-xl border p-2" value={rFrequency} onChange={e=>setRFrequency(e.target.value)}>
                      {FREQUENCIES.map(f=><option key={f.key} value={f.key}>{f.label}</option>)}
                    </select>
                    <div className="col-span-2 grid grid-cols-2 gap-3">
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Anchor date</div>
                        <input type="date" className="rounded-xl border p-2 w-full" value={rAnchor} onChange={e=>setRAnchor(e.target.value)} />
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">End date (optional)</div>
                        <input type="date" className="rounded-xl border p-2 w-full" value={rEnd} onChange={e=>setREnd(e.target.value)} />
                      </div>
                    </div>
                    <button onClick={addRecurring} className="rounded-xl px-4 py-2 bg-blue-600 text-white shadow col-span-2">Add recurring</button>
                    <p className="text-xs text-slate-500 col-span-2">Biweekly uses the anchor as payday and repeats every 14 days.</p>
                  </div>
                </Card>
              </div>
            </section>

            {/* Lists */}
            <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div className="lg:col-span-2">
                <Card>
                  <h2 className="text-lg font-semibold mb-3">Upcoming cashflow</h2>
                  <div className="max-h-96 overflow-auto rounded-xl border">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-100 sticky top-0">
                        <tr>
                          <th className="text-left p-2">Date</th>
                          <th className="text-left p-2">Kind</th>
                          <th className="text-left p-2">Note</th>
                          <th className="text-right p-2">Amount</th>
                          <th className="text-right p-2">Running</th>
                        </tr>
                      </thead>
                      <tbody>
                        {upcoming.items.map(t=>(
                          <tr key={t.id} className="border-t">
                            <td className="p-2 font-mono">{t.date}</td>
                            <td className="p-2">{t.kind}</td>
                            <td className="p-2">{t.note || "—"}</td>
                            <td className={`p-2 text-right font-mono ${t.amount>=0?"text-emerald-700":"text-rose-700"}`}>
                              {t.amount>=0?"+":""}${Number(t.amount).toFixed(2)}
                            </td>
                            <td className={`p-2 text-right font-mono ${t.runBalance>=0?"text-slate-800":"text-rose-700"}`}>
                              ${t.runBalance.toFixed(2)}
                            </td>
                          </tr>
                        ))}
                        {!upcoming.items.length && (
                          <tr><td className="p-4 text-slate-500" colSpan="5">No items in window. Add one-offs or recurrings.</td></tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                  {upcoming.firstNegative && (
                    <div className="mt-3 rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
                      Heads up: you dip below $0 on <b>{upcoming.firstNegative.date}</b> with a projected balance of <b>${upcoming.firstNegative.runBalance.toFixed(2)}</b>.
                    </div>
                  )}
                </Card>
              </div>

              <div className="flex flex-col gap-4">
                <Card>
                  <h3 className="font-semibold mb-2">Recurrings</h3>
                  <ul className="space-y-2">
                    {recurrings.map(r=>(
                      <li key={r.id} className="flex items-start justify-between gap-2 rounded-xl border p-2 bg-white">
                        <div>
                          <div className="font-medium">{r.label}</div>
                          <div className="text-xs text-slate-500">{r.rule.frequency} • anchor {r.rule.anchorDate}{r.endDate?` • ends ${r.endDate}`:""}</div>
                        </div>
                        <div className="text-right">
                          <div className={`font-mono ${r.amount>=0?"text-emerald-700":"text-rose-700"}`}>{r.amount>=0?"+":""}${Number(r.amount).toFixed(2)}</div>
                          <button onClick={()=>removeRecurring(r.id)} className="text-xs text-slate-500 hover:text-rose-700">Remove</button>
                        </div>
                      </li>
                    ))}
                    {!recurrings.length && <div className="text-sm text-slate-500">No recurrings yet.</div>}
                  </ul>
                </Card>

                <Card>
                  <h3 className="font-semibold mb-2">One-offs</h3>
                  <ul className="space-y-2 max-h-64 overflow-auto">
                    {oneOffs
                      .slice()
                      .sort((a,b)=>b.date.localeCompare(a.date))
                      .map(t=>(
                        <li key={t.id} className="flex items-start justify-between gap-2 rounded-xl border p-2 bg-white">
                          <div>
                            <div className="font-mono text-xs text-slate-500">{t.date}</div>
                            <div>{t.note || "—"}</div>
                          </div>
                          <div className="text-right">
                            <div className={`font-mono ${t.amount>=0?"text-emerald-700":"text-rose-700"}`}>{t.amount>=0?"+":""}${Number(t.amount).toFixed(2)}</div>
                            <button onClick={()=>removeOneOff(t.id)} className="text-xs text-slate-500 hover:text-rose-700">Remove</button>
                          </div>
                        </li>
                      ))}
                    {!oneOffs.length && <div className="text-sm text-slate-500">No one-offs yet.</div>}
                  </ul>
                </Card>
              </div>
            </section>

            <footer className="mt-8 text-xs text-slate-500">
              <p>Synced to Firestore for your Google account. Want SoFi auto-import later? We can add Plaid.</p>
            </footer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
